# Portal Jemari 5.0 PaskerID - Apache Configuration
# Prevent access to this file
<Files ".htaccess">
    Order allow,deny
    Deny from all
</Files>

# Enable mod_rewrite
<IfModule mod_rewrite.c>
    RewriteEngine On
    RewriteBase /
    
    # Force HTTPS (uncomment if SSL is available)
    # RewriteCond %{HTTPS} off
    # RewriteRule ^(.*)$ https://%{HTTP_HOST}%{REQUEST_URI} [L,R=301]
    
    # Remove trailing slashes
    RewriteCond %{REQUEST_FILENAME} !-d
    RewriteCond %{THE_REQUEST} /+[^\s]*\s+ [NC]
    RewriteRule ^(.+)\/$ $1 [R=301,L]
    
    # Friendly URLs for main actions
    RewriteRule ^login/?$ auth.php?action=login_form [L,QSA]
    RewriteRule ^logout/?$ auth.php?action=logout [L,QSA]
    RewriteRule ^register/?$ auth.php?action=register_form [L,QSA]
    RewriteRule ^dashboard/?$ index.php?action=dashboard [L,QSA]
    RewriteRule ^admin/?$ loginadm.php [L,QSA]
    
    # Module-specific routes
    RewriteRule ^contacts/?$ index.php?action=contacts [L,QSA]
    RewriteRule ^contacts/create/?$ index.php?action=create_kontak [L,QSA]
    RewriteRule ^contacts/([0-9]+)/edit/?$ index.php?action=edit_kontak&id=$1 [L,QSA]
    
    RewriteRule ^stages/?$ index.php?action=stages [L,QSA]
    RewriteRule ^stages/create/?$ index.php?action=create_stage [L,QSA]
    RewriteRule ^stages/([0-9]+)/edit/?$ index.php?action=edit_stage&id=$1 [L,QSA]
    
    RewriteRule ^documents/?$ index.php?action=documents [L,QSA]
    RewriteRule ^documents/upload/?$ index.php?action=upload_document [L,QSA]
    RewriteRule ^documents/([0-9]+)/view/?$ index.php?action=view_document&id=$1 [L,QSA]
    
    RewriteRule ^schedule/?$ index.php?action=schedule [L,QSA]
    RewriteRule ^schedule/create/?$ index.php?action=create_schedule [L,QSA]
    
    # API routes (if needed in future)
    RewriteRule ^api/(.*)$ api.php?route=$1 [L,QSA]
</IfModule>

# Security Headers
<IfModule mod_headers.c>
    # Prevent clickjacking
    Header always append X-Frame-Options SAMEORIGIN
    
    # Prevent MIME type sniffing
    Header always set X-Content-Type-Options nosniff
    
    # Enable XSS protection
    Header always set X-XSS-Protection "1; mode=block"
    
    # Referrer Policy
    Header always set Referrer-Policy "strict-origin-when-cross-origin"
    
    # Content Security Policy (adjust as needed)
    Header always set Content-Security-Policy "default-src 'self'; script-src 'self' 'unsafe-inline' https://cdnjs.cloudflare.com; style-src 'self' 'unsafe-inline' https://cdnjs.cloudflare.com; img-src 'self' data: https:; font-src 'self' https://cdnjs.cloudflare.com; connect-src 'self'; frame-src 'none'; object-src 'none';"
    
    # Remove server signature
    Header unset Server
    Header unset X-Powered-By
</IfModule>

# Prevent access to sensitive files
<FilesMatch "\.(env|log|ini|sql|md|txt)$">
    Order allow,deny
    Deny from all
</FilesMatch>

# Prevent access to sensitive directories
RedirectMatch 404 ^/(config|includes|logs|storage|database)/.*$

# Prevent access to backup and temporary files
<FilesMatch "\.(bak|backup|old|tmp|temp|~)$">
    Order allow,deny
    Deny from all
</FilesMatch>

# Prevent access to version control files
<FilesMatch "\.(git|svn|hg)">
    Order allow,deny
    Deny from all
</FilesMatch>

# Disable PHP execution in upload directories
<Directory "assets/uploads">
    <FilesMatch "\.php$">
        Order allow,deny
        Deny from all
    </FilesMatch>
</Directory>

# Enable compression for better performance
<IfModule mod_deflate.c>
    # Compress HTML, CSS, JavaScript, Text, XML and fonts
    AddOutputFilterByType DEFLATE application/javascript
    AddOutputFilterByType DEFLATE application/rss+xml
    AddOutputFilterByType DEFLATE application/vnd.ms-fontobject
    AddOutputFilterByType DEFLATE application/x-font
    AddOutputFilterByType DEFLATE application/x-font-opentype
    AddOutputFilterByType DEFLATE application/x-font-otf
    AddOutputFilterByType DEFLATE application/x-font-truetype
    AddOutputFilterByType DEFLATE application/x-font-ttf
    AddOutputFilterByType DEFLATE application/x-javascript
    AddOutputFilterByType DEFLATE application/xhtml+xml
    AddOutputFilterByType DEFLATE application/xml
    AddOutputFilterByType DEFLATE font/opentype
    AddOutputFilterByType DEFLATE font/otf
    AddOutputFilterByType DEFLATE font/ttf
    AddOutputFilterByType DEFLATE image/svg+xml
    AddOutputFilterByType DEFLATE image/x-icon
    AddOutputFilterByType DEFLATE text/css
    AddOutputFilterByType DEFLATE text/html
    AddOutputFilterByType DEFLATE text/javascript
    AddOutputFilterByType DEFLATE text/plain
    AddOutputFilterByType DEFLATE text/xml
    
    # Remove browser bugs (optional)
    BrowserMatch ^Mozilla/4 gzip-only-text/html
    BrowserMatch ^Mozilla/4\.0[678] no-gzip
    BrowserMatch \bMSIE !no-gzip !gzip-only-text/html
    Header append Vary User-Agent
</IfModule>

# Enable browser caching
<IfModule mod_expires.c>
    ExpiresActive On
    ExpiresByType text/css "access plus 1 month"
    ExpiresByType application/javascript "access plus 1 month"
    ExpiresByType image/png "access plus 1 month"
    ExpiresByType image/jpg "access plus 1 month"
    ExpiresByType image/jpeg "access plus 1 month"
    ExpiresByType image/gif "access plus 1 month"
    ExpiresByType image/ico "access plus 1 month"
    ExpiresByType image/icon "access plus 1 month"
    ExpiresByType text/plain "access plus 1 month"
    ExpiresByType application/pdf "access plus 1 month"
    ExpiresByType font/woff "access plus 1 month"
    ExpiresByType font/woff2 "access plus 1 month"
    ExpiresByType application/font-woff "access plus 1 month"
    ExpiresByType application/font-woff2 "access plus 1 month"
</IfModule>

# Custom error pages (create these files if needed)
ErrorDocument 404 /404.php
ErrorDocument 403 /403.php
ErrorDocument 500 /500.php

# Limit file upload size (adjust as needed)
php_value upload_max_filesize 10M
php_value post_max_size 10M

# Increase memory limit if needed
php_value memory_limit 128M

# Set maximum execution time
php_value max_execution_time 300

# Disable server signature for security
ServerSignature Off

# Prevent access to composer files
<FilesMatch "(composer\.(json|lock)|package\.(json|lock))">
    Order allow,deny
    Deny from all
</FilesMatch>

# Additional security: Prevent access to PHP files that should not be directly accessed
<FilesMatch "^(functions|validation|csrf|session)\.php$">
    Order allow,deny
    Deny from all
</FilesMatch>

# Optional: Redirect www to non-www (uncomment if needed)
# RewriteCond %{HTTP_HOST} ^www\.(.*)$ [NC]
# RewriteRule ^(.*)$ https://%1/$1 [R=301,L]

# Or redirect non-www to www (alternative - choose one)
# RewriteCond %{HTTP_HOST} ^[^.]+\.[^.]+$
# RewriteRule ^(.*)$ https://www.%{HTTP_HOST}/$1 [R=301,L]

# Additional file type restrictions
<FilesMatch "\.(htaccess|htpasswd|ini|phps|fla|psd|log|sh)$">
    Order Allow,Deny
    Deny from all
</FilesMatch>

# Prevent access to configuration files
<FilesMatch "^(config|database|functions|validation|csrf|session|\.env)\.php$">
    Order allow,deny
    Deny from all
</FilesMatch>

# Prevent direct access to includes directory
<Directory "includes">
    Order allow,deny
    Deny from all
</Directory>

# Prevent direct access to controllers directory (for security)
<Directory "controllers">
    <FilesMatch "\.php$">
        # Allow access only to specific controller files if needed
        # Order allow,deny
        # Deny from all
    </FilesMatch>
</Directory>

# Prevent direct access to models directory
<Directory "models">
    <FilesMatch "\.php$">
        # Allow limited access to model files
        # Order allow,deny
        # Deny from all
    </FilesMatch>
</Directory>

# Additional friendly URLs for better SEO
RewriteRule ^admin/dashboard/?$ admin_dashboard.php [L,QSA]
RewriteRule ^admin/users/?$ admin_dashboard.php?section=users [L,QSA]
RewriteRule ^admin/settings/?$ admin_dashboard.php?section=settings [L,QSA]

# Handle contact-specific routes with better structure
RewriteRule ^contacts/([0-9]+)/?$ index.php?action=view_kontak&id=$1 [L,QSA]
RewriteRule ^contacts/([0-9]+)/delete/?$ index.php?action=delete_kontak&id=$1 [L,QSA]

# Handle stage-specific routes
RewriteRule ^stages/([a-z]+)/?$ index.php?action=stages&type=$1 [L,QSA]
RewriteRule ^stages/([0-9]+)/?$ index.php?action=view_stage&id=$1 [L,QSA]
RewriteRule ^stages/([0-9]+)/delete/?$ index.php?action=delete_stage&id=$1 [L,QSA]

# Handle document routes
RewriteRule ^documents/([0-9]+)/?$ index.php?action=view_document&id=$1 [L,QSA]
RewriteRule ^documents/([0-9]+)/download/?$ index.php?action=download_document&id=$1 [L,QSA]
RewriteRule ^documents/([0-9]+)/delete/?$ index.php?action=delete_document&id=$1 [L,QSA]

# Handle schedule routes
RewriteRule ^schedule/([0-9]+)/?$ index.php?action=view_schedule&id=$1 [L,QSA]
RewriteRule ^schedule/([0-9]+)/edit/?$ index.php?action=edit_schedule&id=$1 [L,QSA]
RewriteRule ^schedule/([0-9]+)/delete/?$ index.php?action=delete_schedule&id=$1 [L,QSA]

# Force download for certain file types in uploads
<Directory "assets/uploads">
    <FilesMatch "\.(pdf|doc|docx|xls|xlsx|zip|rar)$">
        Header set Content-Disposition "attachment"
    </FilesMatch>
</Directory>

# Optimize images
<IfModule mod_headers.c>
    <FilesMatch "\.(jpg|jpeg|png|gif|webp)$">
        Header set Cache-Control "max-age=2592000, public"
    </FilesMatch>
</IfModule>

# Enable GZIP compression for additional file types
<IfModule mod_deflate.c>
    AddOutputFilterByType DEFLATE application/json
    AddOutputFilterByType DEFLATE text/csv
    AddOutputFilterByType DEFLATE application/pdf
</IfModule>

# Limit request methods (security enhancement)
<LimitExcept GET POST HEAD>
    deny from all
</LimitExcept>

# Set proper MIME types
AddType application/javascript .js
AddType text/css .css
AddType image/svg+xml .svg
AddType font/woff .woff
AddType font/woff2 .woff2

# Additional security headers for modern browsers
<IfModule mod_headers.c>
    # Strict Transport Security (HTTPS only - uncomment when SSL is ready)
    # Header always set Strict-Transport-Security "max-age=31536000; includeSubDomains; preload"
    
    # Permissions Policy (formerly Feature Policy)
    Header always set Permissions-Policy "geolocation=(), microphone=(), camera=(), payment=(), usb=(), magnetometer=(), accelerometer=(), gyroscope=()"
    
    # Additional XSS protection
    Header always set X-XSS-Protection "1; mode=block"
    
    # Prevent MIME type confusion attacks
    Header always set X-Content-Type-Options "nosniff"
    
    # Control referrer information
    Header always set Referrer-Policy "strict-origin-when-cross-origin"
</IfModule>

# Prevent hotlinking of images (optional)
# RewriteCond %{HTTP_REFERER} !^$
# RewriteCond %{HTTP_REFERER} !^https?://(www\.)?yourdomain\.com [NC]
# RewriteRule \.(jpg|jpeg|png|gif)$ - [F]

# Custom maintenance page (create maintenance.html when needed)
# RewriteEngine On
# RewriteCond %{REQUEST_URI} !/maintenance.html$
# RewriteCond %{REMOTE_ADDR} !^123\.123\.123\.123
# RewriteRule $ /maintenance.html [R=302,L]

# Log custom errors for debugging (optional)
# LogLevel warn
# ErrorLog logs/error.log
# CustomLog logs/access.log combined